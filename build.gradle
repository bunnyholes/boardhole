// Load local properties if they exist (for sensitive credentials)
def localPropertiesFile = file('gradle-local.properties')
if (localPropertiesFile.exists()) {
    def localProperties = new Properties()
    localProperties.load(new FileInputStream(localPropertiesFile))
    localProperties.each { key, value ->
        if (key.startsWith("systemProp.")) {
            System.setProperty(key.substring(11), value)
        }
    }
}

plugins {
    id 'java'
    id 'org.springframework.boot' version '3.5.5'
    id 'io.spring.dependency-management' version '1.1.7'
    id 'org.openrewrite.rewrite' version '7.15.0'
    id 'com.github.ben-manes.versions' version '0.52.0'
    id 'checkstyle'
    id 'org.sonarqube' version '6.3.1.5724'
    id 'com.github.spotbugs' version '6.2.6'
    id 'net.researchgate.release' version '3.0.2'
    id 'org.hildan.github.changelog' version '2.2.0'
}

group = 'bunny'
// versionÏùÄ gradle.propertiesÏóêÏÑú Í¥ÄÎ¶¨
description = 'board-hole'

springBoot {
    buildInfo()  // BuildProperties Îπà ÏÉùÏÑ±ÏúºÎ°ú Î≤ÑÏ†Ñ Ï†ïÎ≥¥Î•º Îü∞ÌÉÄÏûÑÏóê ÏÇ¨Ïö© Í∞ÄÎä•
}

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}

repositories {
    mavenCentral()
}

dependencies {
    // -- SpotBugs Security Plugin --
    spotbugsPlugins 'com.h3xstream.findsecbugs:findsecbugs-plugin:1.14.0'
    
    // -- Core Spring Boot Starters --
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-validation'
    implementation 'org.springframework.boot:spring-boot-starter-aop'
    implementation 'org.springframework.boot:spring-boot-starter-security'
    
    // -- Session Management (Redis) --
    implementation 'org.springframework.boot:spring-boot-starter-data-redis'
    implementation 'org.springframework.session:spring-session-data-redis'

    // -- API Documentation (SpringDoc) --
    implementation "org.springdoc:springdoc-openapi-starter-webmvc-ui:2.8.11"
    implementation "org.springdoc:springdoc-openapi-starter-webmvc-api:2.8.11"

    // -- Mapping (MapStruct) --
    implementation "org.mapstruct:mapstruct:1.6.3"
    annotationProcessor "org.mapstruct:mapstruct-processor:1.6.3"
    annotationProcessor "org.projectlombok:lombok-mapstruct-binding:0.2.0"

    // -- Lombok --
    compileOnly "org.projectlombok:lombok:1.18.38"
    annotationProcessor "org.projectlombok:lombok:1.18.38"

    // -- Database Drivers --
    runtimeOnly "com.mysql:mysql-connector-j:9.4.0"

    // -- Logging (JSON encoder, opt-in in prod) --
    implementation "net.logstash.logback:logstash-logback-encoder:8.1"

    // -- Dev only --
    developmentOnly 'org.springframework.boot:spring-boot-docker-compose'

    // -- Testing --
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testImplementation 'org.springframework.security:spring-security-test'
    testImplementation 'com.h2database:h2'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
    
    // -- ArchUnit for architecture testing --
    testImplementation 'com.tngtech.archunit:archunit-junit5:1.4.1'

    // -- OpenRewrite recipes (static analysis/refactoring) --
    rewrite 'org.openrewrite.recipe:rewrite-spring:6.13.0'
    rewrite 'org.openrewrite.recipe:rewrite-static-analysis:2.16.0'

    // (Removed) REST Docs and restdocs-api-spec
}

tasks.named('test') {
    useJUnitPlatform()
    
    testLogging {
        events "passed", "skipped", "failed"
        exceptionFormat = "short"
    }
}
// Removed REST Docs related tasks and plugins


rewrite {
    activeRecipe('bunny.boardhole.refactor.main')
    exportDatatables = true
}

checkstyle {
    toolVersion = '10.12.5'
    configFile = file("${rootDir}/config/checkstyle/checkstyle.xml")
    maxWarnings = 0
    ignoreFailures = false
}

tasks.withType(Checkstyle) {
    reports {
        xml.required = true
        html.required = true
    }
}

sonarqube {
    properties {
        property "sonar.projectKey", "bunnyxiyo_board-hole"
        property "sonar.organization", "bunnyxiyo"
        property "sonar.host.url", "https://sonarcloud.io"
        property "sonar.sources", "src/main/java"
        property "sonar.tests", "src/test/java"
        property "sonar.java.binaries", "build/classes"
        property "sonar.java.test.binaries", "build/test-results/test"
        property "sonar.exclusions", "**/*Test.java, **/*Tests.java, **/test/**"
    }
}

task sonarAnalysis {
    group = 'verification'
    description = 'Run SonarCloud analysis'
    doLast {
        println 'Running SonarCloud analysis...'
        println 'Execute: ./gradlew sonar'
    }
    dependsOn 'sonar'
}

spotbugs {
    toolVersion = '4.8.6'
    effort = 'max'  // Î∂ÑÏÑù Í∞ïÎèÑ: min, default, max
    reportLevel = 'medium'  // Î≤ÑÍ∑∏ Î¶¨Ìè¨Ìä∏ Î†àÎ≤®: low, medium, high
    ignoreFailures = false  // Î≤ÑÍ∑∏ Î∞úÍ≤¨Ïãú ÎπåÎìú Ïã§Ìå® Ïó¨Î∂Ä
}

spotbugsMain {
    reports {
        html {
            required = true
            outputLocation = file("$buildDir/reports/spotbugs/main.html")
        }
        xml {
            required = false  // SonarCloud Ïó∞ÎèôÏãú trueÎ°ú Î≥ÄÍ≤Ω
        }
        text {
            required = true  // ÌÑ∞ÎØ∏ÎÑê Ï∂úÎ†•Ïö©
            outputLocation = file("$buildDir/reports/spotbugs/main.txt")
        }
    }
}

spotbugsTest {
    reports {
        html {
            required = true
            outputLocation = file("$buildDir/reports/spotbugs/test.html")
        }
        text {
            required = false
        }
    }
}

task spotbugsConsole {
    group = 'verification'
    description = 'Run SpotBugs and display results in console'
    dependsOn 'spotbugsMain'
    doLast {
        def reportFile = file("$buildDir/reports/spotbugs/main.txt")
        if (reportFile.exists()) {
            println "\n========== SpotBugs Analysis Results =========="
            println reportFile.text
            println "================================================\n"
        } else {
            println "No bugs found! ‚úÖ"
        }
    }
}

// Semantic Versioning ÏûêÎèôÌôî ÏÑ§Ï†ï
release {
    failOnCommitNeeded = true
    failOnPublishNeeded = true
    failOnSnapshotDependencies = true
    failOnUnversionedFiles = true
    failOnUpdateNeeded = true
    revertOnFail = true
    
    tagTemplate = 'v${version}'
    versionPropertyFile = 'gradle.properties'
    
    preCommitText = '[Release]'
    preTagCommitMessage = 'Release version'
    newVersionCommitMessage = 'Prepare next version'
    tagCommitMessage = 'Release version'
    
    buildTasks = ['build']
    
    git {
        requireBranch.set('master')
        pushToRemote.set('origin')
    }
}

// Changelog ÏûêÎèô ÏÉùÏÑ± ÏÑ§Ï†ï
changelog {
    githubUser = 'bunnyxiyo'
    githubRepository = 'board-hole'
    
    outputFile = file("${projectDir}/CHANGELOG.md")
    
    // Sections configuration
    sections = [
        [title: '‚ú® New Features', labels: ['feature', 'enhancement', 'feat']],
        [title: 'üêõ Bug Fixes', labels: ['bug', 'fix', 'bugfix']],
        [title: 'üìù Documentation', labels: ['documentation', 'docs']],
        [title: '‚ôªÔ∏è Refactoring', labels: ['refactor', 'refactoring']],
        [title: 'üîß Maintenance', labels: ['chore', 'maintenance']],
        [title: '‚ö° Performance', labels: ['performance', 'perf']],
        [title: 'üîí Security', labels: ['security']],
        [title: '‚úÖ Tests', labels: ['test', 'tests', 'testing']]
    ]
    
    excludeLabels = ['duplicate', 'wontfix', 'invalid', 'question']
}

// ÌÜµÌï© Î¶¥Î¶¨Ï¶à ÌÉúÏä§ÌÅ¨
task releaseWithChangelog {
    group = 'release'
    description = 'Generate changelog and perform release'
    dependsOn 'generateChangelog'
    finalizedBy 'release'
    
    doLast {
        println """
        ======================================
        üì¶ Release Process Started
        ======================================
        1. Generating CHANGELOG.md from GitHub PRs/Issues
        2. Updating version in gradle.properties
        3. Creating Git tag
        4. Pushing to remote repository
        ======================================
        """
    }
}

// ÎìúÎùºÏù¥Îü∞ ÌÉúÏä§ÌÅ¨
task releaseDryRun {
    group = 'release'
    description = 'Dry run of release process (no actual changes)'
    
    doLast {
        println """
        ======================================
        üîç Release Dry Run
        ======================================
        Current version: ${project.version}
        Next patch version would be: ${project.version.toString().replace('-SNAPSHOT', '').split('\\.').with { 
            "${it[0]}.${it[1]}.${(it[2] as Integer) + 1}"
        }}
        Tag would be: v${project.version.toString().replace('-SNAPSHOT', '')}
        ======================================
        Run './gradlew release' to perform actual release
        Run './gradlew generateChangelog' to preview CHANGELOG
        ======================================
        """
    }
}

// ÎÇ¥Î∂Ä Ìå®Ïπò Î≤ÑÏ†Ñ Í¥ÄÎ¶¨ ÌÉúÏä§ÌÅ¨Îì§
task buildAlpha {
    group = 'release'
    description = 'Build with alpha version (use -Palpha=1)'
    
    doLast {
        def alphaNumber = project.hasProperty('alpha') ? project.alpha : '1'
        def alphaVersion = "${project.version.toString().replace('-SNAPSHOT', '')}-alpha.${alphaNumber}"
        println "Building Alpha Version: ${alphaVersion}"
    }
    
    dependsOn 'build'
}

task buildBeta {
    group = 'release'
    description = 'Build with beta version (use -Pbeta=1)'
    
    doLast {
        def betaNumber = project.hasProperty('beta') ? project.beta : '1'
        def betaVersion = "${project.version.toString().replace('-SNAPSHOT', '')}-beta.${betaNumber}"
        println "Building Beta Version: ${betaVersion}"
    }
    
    dependsOn 'build'
}

task buildRC {
    group = 'release'
    description = 'Build with RC version (use -Prc=1)'
    
    doLast {
        def rcNumber = project.hasProperty('rc') ? project.rc : '1'
        def rcVersion = "${project.version.toString().replace('-SNAPSHOT', '')}-rc.${rcNumber}"
        println "Building Release Candidate: ${rcVersion}"
    }
    
    dependsOn 'build'
}

task buildWithGitHash {
    group = 'release'
    description = 'Build with git commit hash in version'
    
    doLast {
        def gitHash = 'unknown'
        try {
            def stdout = new ByteArrayOutputStream()
            exec {
                commandLine 'git', 'rev-parse', '--short', 'HEAD'
                standardOutput = stdout
            }
            gitHash = stdout.toString().trim()
        } catch (Exception e) {
            // ignore
        }
        
        def hashVersion = "${project.version}-${gitHash}"
        println "Building with Git Hash: ${hashVersion}"
    }
    
    dependsOn 'build'
}

task buildWithTimestamp {
    group = 'release'
    description = 'Build with timestamp in version'
    
    doLast {
        def timestamp = new Date().format('yyyyMMddHHmmss')
        def timestampVersion = "${project.version}-${timestamp}"
        println "Building with Timestamp: ${timestampVersion}"
    }
    
    dependsOn 'build'
}

// Î≤ÑÏ†Ñ Ï†ïÎ≥¥ Ï∂úÎ†• ÌÉúÏä§ÌÅ¨
task showVersion {
    group = 'release'
    description = 'Show current project version'
    
    doLast {
        println """
        ======================================
        üì¶ Version Information
        ======================================
        Base Version: ${project.version}
        Group: ${project.group}
        Project: ${project.name}
        ======================================
        Available version types:
        - Alpha: ./gradlew buildAlpha -Palpha=1
        - Beta: ./gradlew buildBeta -Pbeta=1
        - RC: ./gradlew buildRC -Prc=1
        - Git Hash: ./gradlew buildWithGitHash
        - Timestamp: ./gradlew buildWithTimestamp
        - CI Build: ./gradlew build -PbuildNumber=123
        ======================================
        """
    }
}
